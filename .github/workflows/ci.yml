name: ğŸš€ DevOps Monitoring Stack CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * *'

env:
  COMPOSE_FILE: docker-compose.yml
  HEALTH_CHECK_TIMEOUT: 120

jobs:
  lint-and-validate:
    name: ğŸ” Lint & Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ³ Validate Docker Compose
      run: |
        echo "ğŸ” Validating docker-compose.yml syntax..."
        docker compose config
        echo "âœ… Docker Compose syntax is valid!"
        
    - name: ğŸ“‹ Validate Configuration Files
      run: |
        echo "ğŸ” Checking configuration files..."
        
        # Check Prometheus config
        if [ -f "prometheus/prometheus.yml" ]; then
          echo "âœ… Prometheus config exists"
          echo "ğŸ“Š Prometheus targets:"
          grep -A 5 "targets:" prometheus/prometheus.yml || true
        fi
        
        # Check Nginx config  
        if [ -f "nginx/nginx.conf" ]; then
          echo "âœ… Nginx config exists"
          echo "ğŸŒ Nginx status location:"
          grep -n "status" nginx/nginx.conf || true
        fi
        
        echo "âœ… Configuration validation completed!"

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ›¡ï¸ Run Trivy security scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

  integration-test:
    name: ğŸ§ª Integration Tests
    runs-on: ubuntu-latest
    needs: [lint-and-validate, security-scan]
    
    strategy:
      matrix:
        test-scenario: [basic, load-test]
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ³ Start monitoring stack
      run: |
        echo "ğŸš€ Starting all services..."
        docker compose up -d
        echo "ğŸ“Š Services started, checking containers..."
        docker compose ps
        
    - name: â³ Wait for services to be ready
      run: |
        echo "â³ Waiting for services to initialize..."
        sleep 60
        
    - name: ğŸ§ª Health Check Tests
      run: |
        echo "=== ğŸŒ Testing Web Application ==="
        for i in {1..5}; do
          if curl -f -s http://localhost:7070; then
            echo "âœ… Web app responding (attempt $i)"
            break
          fi
          echo "â³ Web app not ready, waiting... (attempt $i)"
          sleep 10
        done
        
        echo "=== ğŸ“Š Testing Prometheus ==="
        for i in {1..5}; do
          if curl -f -s http://localhost:9090/-/healthy; then
            echo "âœ… Prometheus healthy (attempt $i)"
            break
          fi
          echo "â³ Prometheus not ready, waiting... (attempt $i)"
          sleep 10
        done
        
        echo "=== ğŸ“ˆ Testing Grafana ==="
        for i in {1..5}; do
          if curl -f -s http://localhost:3000/api/health; then
            echo "âœ… Grafana healthy (attempt $i)"
            break
          fi
          echo "â³ Grafana not ready, waiting... (attempt $i)"
          sleep 10
        done
        
        echo "=== ğŸ”¢ Testing Nginx Exporter ==="
        for i in {1..5}; do
          if curl -f -s http://localhost:9113/metrics | grep -q "nginx_up"; then
            echo "âœ… Nginx Exporter working (attempt $i)"
            break
          fi
          echo "â³ Nginx Exporter not ready, waiting... (attempt $i)"
          sleep 10
        done
        
    - name: ğŸ“Š Metrics Validation
      run: |
        echo "=== ğŸ“Š Validating Metrics Collection ==="
        
        echo "ğŸ¯ Checking Prometheus targets..."
        curl -s "http://localhost:9090/api/v1/targets" | head -200
        
        echo "ğŸ” Testing basic Prometheus queries..."
        curl -s "http://localhost:9090/api/v1/query?query=up" | head -200
        
    - name: ğŸš¨ Load Testing
      if: matrix.test-scenario == 'load-test'
      run: |
        echo "=== ğŸš¨ Running Load Test ==="
        
        sudo apt-get update && sudo apt-get install -y apache2-utils
        
        echo "ğŸ”¥ Running light load test..."
        ab -n 50 -c 5 http://localhost:7070/
        
        echo "ğŸ“Š Checking metrics after load..."
        curl -s "http://localhost:9090/api/v1/query?query=nginx_up"
        
    - name: ğŸ“‹ Generate Test Report
      if: always()
      run: |
        echo "=== ğŸ“‹ Test Report ===" > test-report.txt
        echo "Date: $(date)" >> test-report.txt
        echo "Test Scenario: ${{ matrix.test-scenario }}" >> test-report.txt
        echo "Container Status:" >> test-report.txt
        docker compose ps >> test-report.txt
        
    - name: ğŸ“¤ Upload Test Report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-report-${{ matrix.test-scenario }}
        path: test-report.txt
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up..."
        docker compose down -v

  deployment-ready:
    name: ğŸš¢ Deployment Ready
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ·ï¸ Create Release Info
      run: |
        VERSION="v$(date +%Y.%m.%d)-$(echo ${{ github.sha }} | cut -c1-7)"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "ğŸ·ï¸ Version: $VERSION"
        
    - name: ğŸ“¦ Final Validation
      run: |
        echo "ğŸ“¦ Running final validation..."
        docker compose up -d
        sleep 60
        
        curl -f http://localhost:7070
        curl -f http://localhost:9090/-/healthy  
        curl -f http://localhost:3000/api/health
        
        docker compose down
        echo "âœ… Deployment validation completed!"

  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [integration-test, deployment-ready]
    if: always()
    
    steps:
    - name: ğŸ“§ Success Notification
      if: needs.integration-test.result == 'success'
      run: |
        echo "ğŸ‰ SUCCESS: CI/CD Pipeline completed successfully!"
        echo "ğŸ“Š All integration tests passed"
        echo "ğŸš€ Ready for deployment"
        
    - name: ğŸš¨ Failure Notification
      if: failure()
      run: |
        echo "âŒ FAILURE: CI/CD Pipeline failed!"
        echo "ğŸ” Please check the workflow logs for details"